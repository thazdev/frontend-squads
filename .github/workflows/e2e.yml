name: e2e-smoke

on:
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest

    services:
      arango:
        image: arangodb:latest
        env: { ARANGO_ROOT_PASSWORD: root }
        ports: [8529:8529]

    steps:
    # ── checkout
    - uses: actions/checkout@v4

    # ── pnpm + Node + cache da store
    - uses: pnpm/action-setup@v3
      with: { version: 8 }
    - uses: actions/setup-node@v3
      with: { node-version: 20 }
    - uses: actions/cache@v4
      with:
        path: ~/.local/share/pnpm/store/v3
        key: pnpm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
        restore-keys: pnpm-${{ runner.os }}-

    # ── cache dos browsers Playwright (só Chromium)
    - uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: pw-${{ runner.os }}-1.42.1

    # ── dependências do frontend (raiz)
    - run: pnpm install --no-frozen-lockfile

    # ── instala apenas o Chromium
    - run: PW_BRANCH=chromium pnpm exec playwright install chromium
      env: { PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS: 1 }

    # ── clona backend e instala deps (store já cacheada → ~2 s)
    - name: Clone + install backend
      run: |
        git clone --depth 1 https://github.com/thazdev/backend-squads.git backend
        cd backend
        pnpm install --no-frozen-lockfile

    # ── seed rápido das coleções no _system
    - run: |
        for col in users squads tasks; do
          curl -s -u root:root -X POST http://localhost:8529/_api/collection \
            -H 'Content-Type: application/json' \
            -d "{\"name\":\"$col\"}" || true
        done

    # ── executa testes (Playwright config já sobe backend + Vite em modo dev)
    - run: pnpm exec playwright test tests/specs/smoke.spec.ts \
         --reporter=list,github,json
