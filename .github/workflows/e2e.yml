name: e2e-smoke

on:
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest

    services:
      arango:
        image: arangodb:latest
        env: { ARANGO_ROOT_PASSWORD: root }
        ports: [8529:8529]

    steps:
    # 1 â–¸ checkout
    - uses: actions/checkout@v4

    # 2 â–¸ pnpm + Node + cache da store
    - uses: pnpm/action-setup@v3
      with: { version: 8 }
    - uses: actions/setup-node@v3
      with: { node-version: 20 }
    - uses: actions/cache@v4
      with:
        path: ~/.local/share/pnpm/store/v3
        key: pnpm-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
        restore-keys: pnpm-${{ runner.os }}-

    # 3 â–¸ cache do Chromium (Playwright)
    - uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: pw-${{ runner.os }}-1.42.1

    # 4 â–¸ deps do frontend
    - run: pnpm install --no-frozen-lockfile

    # 5 â–¸ instala apenas Chromium
    - run: PW_BRANCH=chromium pnpm exec playwright install chromium
      env: { PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS: 1 }

    # 6 â–¸ clone + deps backend
    - name: Clone + install backend
      run: |
        git clone --depth 1 https://github.com/thazdev/backend-squads.git backend
        cd backend && pnpm install --no-frozen-lockfile

    # 7 â–¸ seed coleÃ§Ãµes no _system
    - run: |
        for col in users squads tasks; do
          curl -s -u root:root -X POST http://localhost:8529/_api/collection \
               -H 'Content-Type: application/json' -d "{\"name\":\"$col\"}" || true
        done

    # 8 â–¸ start backend
    - name: Start backend
      working-directory: backend
      run: |
        pnpm exec ts-node --transpile-only src/index.ts >/tmp/back.log 2>&1 &
        for i in {1..15}; do nc -z localhost 4000 && exit 0; sleep 2; done
        echo "::error::Backend nÃ£o subiu"; cat /tmp/back.log; exit 1

    # 9 â–¸ start Vite dev
    - name: Start frontend (Vite dev)
      run: |
        pnpm exec vite --host --port 5173 >/tmp/vite.log 2>&1 &
        for i in {1..15}; do nc -z localhost 5173 && exit 0; sleep 2; done
        echo "::error::Vite nÃ£o subiu"; cat /tmp/vite.log; exit 1

    # 10 â–¸ smoke-tests â€” 1Âª exec: log curto / 2Âª exec: JSON
    - name: Run smoke tests (quiet)
      run: |
        # saÃ­da curta para humanos
        pnpm exec playwright test tests/specs/smoke.spec.ts \
          --reporter=dot,github --quiet \
          | tee $RUNNER_TEMP/test-output.txt

        # segunda execuÃ§Ã£o grava JSON em playwright-report/result.json
        pnpm exec playwright test tests/specs/smoke.spec.ts \
          --reporter=json=playwright-report/result.json || true

    # 11 â–¸ artefato JSON
    - uses: actions/upload-artifact@v4
      with:
        name: playwright-json
        path: playwright-report/result.json
        retention-days: 5

    # 12 â–¸ Job Summary (pass / fail + mensagem)
    - name: Summary ğŸ¯
      if: always()
      run: |
        node - <<'NODE' > /tmp/summary.md
        const fs = require('fs');
        let data;
        try {  
          data = JSON.parse(fs.readFileSync('playwright-report/result.json','utf8'));
        } catch {
          console.log('## ğŸ§ª Smoke-tests\nFalha ao ler playwright-report/result.json');
          process.exit(0);
        }

        let passed = 0;
        const failures = [];
        for (const s of data.suites || [])
          for (const sp of s.specs || [])
            for (const t of sp.tests || []) {
              if (t.status === 'passed') passed++;
              else if (t.status === 'failed') {
                const msg = (t.error?.message || '').split('\n')[0];
                failures.push({ title: sp.title, msg });
              }
            }

        console.log('## ğŸ§ª Smoke-tests');
        console.log(`- âœ…  Passed: **${passed}**`);
        console.log(`- âŒ  Failed: **${failures.length}**\n`);
        if (failures.length) {
          console.log('<details><summary>â›” Failed tests (click)</summary>');
          failures.forEach(f => console.log(`- **${f.title}** â†’ ${f.msg}`));
          console.log('</details>');
        }
        console.log('\nğŸ”— Artefato JSON completo: _playwright-json_');
        NODE
        
               cat /tmp/summary.md >> "$GITHUB_STEP_SUMMARY"
